import{N as te,d as Z,P as ie,e as C,F as ae,K as Q,Q as I,k as g,j as _,s as M,h as T,x as fe,g as A,f as W,R as pe,_ as ee,S as me,w as oe,u as se,U as he,a as ye,V as ge,X as be,q as we,y as Se,r as v,o as ke,n as _e,Z as k,c as Ee,J as Me,i as Ce,t as We,$ as xe,p as Re}from"./index-CH0RtBGW.js";import{p as Le,_ as $e}from"./DifficultyTag.vue_vue_type_script_setup_true_lang-gGtqeSFm.js";const B={WALL_WIDTH_MM:2500,WALL_HEIGHT_MM:3330};async function Te(l,c=[],u=null){const p=await(await fetch("wall.svg")).text(),m=new DOMParser,o=new te.Layer;return m.parseFromString(p,"image/svg+xml").querySelectorAll("path").forEach((x,j)=>{const P=x.getAttribute("d"),R=x.getAttribute("fill")||"white",H=x.getAttribute("stroke")||"black",O=parseFloat(x.getAttribute("stroke-width")||"13"),f=`${j}`,y=c.includes(f),L=u===f;let w=R,d=.3;y?(w="green",d=1):L&&(w="red",d=1);const i=new te.Path({id:f,data:P||"",fill:w,stroke:H,strokeWidth:O,opacity:d,listening:!0,perfectDrawEnabled:!1,hitStrokeWidth:20});let b=0;const r=300,S=E=>{E&&E.evt&&(E.evt.preventDefault?.(),E.evt.stopPropagation?.());const V=Date.now();V-b<r||(b=V,l&&l(f))};i.on("tap",S),i.on("click",E=>{"ontouchstart"in window||S(E)});const N=i.getClientRect({skipTransform:!0}),G=N.x+N.width/2,U=N.y+N.height/2,q=G-i.x(),K=U-i.y();i.offsetX(q),i.offsetY(K),i.x(i.x()+q),i.y(i.y()+K),o.add(i)}),o}function ne(l,c){l.offsetX(B.WALL_WIDTH_MM/2),l.offsetY(B.WALL_HEIGHT_MM/2);const u=B.WALL_WIDTH_MM/B.WALL_HEIGHT_MM,s=c.width()/c.height();let p;return s>u?p=c.height()/B.WALL_HEIGHT_MM:p=c.width()/B.WALL_WIDTH_MM,l.position({x:c.width()/2,y:c.height()/2}),l.scale({x:p,y:p}),l}const Ae={key:0,class:"action-bar"},He={key:1,class:"mobile-action-bar"},Ne=["onClick","title"],De=Z({__name:"ActionButtons",props:{isMobile:{type:Boolean},isSessionRoute:{type:Boolean},startMode:{type:Boolean},endMode:{type:Boolean}},emits:["save","cancel","editInfo","flip","start","end"],setup(l,{emit:c}){const u=l,s=c,p=ie(()=>[{label:"Save",icon:"pi pi-check",command:()=>s("save"),tooltip:"Save",class:""},{label:"Cancel",icon:"pi pi-times",command:()=>s("cancel"),tooltip:"Cancel",class:""},{label:"Edit",icon:"pi pi-pencil",command:()=>s("editInfo"),tooltip:"Edit info",class:""},{label:"Start",icon:"pi pi-play",command:()=>s("start"),tooltip:"Start",class:u.startMode?"mobile-action-start":""},{label:"End",icon:"pi pi-stop-circle",command:()=>s("end"),tooltip:"End",class:u.endMode?"mobile-action-end":""},{label:"Flip",icon:"pi pi-refresh",command:()=>s("flip"),tooltip:"Flip",class:""}]);return(m,o)=>{const h=pe;return W(),C(ae,null,[!l.isMobile&&!l.isSessionRoute?(W(),C("div",Ae,[I(g(_(M),{icon:"pi pi-check",class:"action-bar-button",onClick:o[0]||(o[0]=n=>m.$emit("save")),rounded:""},null,512),[[h,"Save",void 0,{left:!0}]]),I(g(_(M),{icon:"pi pi-times",class:"action-bar-button",onClick:o[1]||(o[1]=n=>m.$emit("cancel")),rounded:""},null,512),[[h,"Cancel",void 0,{left:!0}]]),I(g(_(M),{icon:"pi pi-pencil",class:"action-bar-button",onClick:o[2]||(o[2]=n=>m.$emit("editInfo")),rounded:""},null,512),[[h,"Edit info",void 0,{left:!0}]]),I(g(_(M),{icon:"pi pi-play",class:T(["action-bar-button",{"action-bar-button-start":l.startMode}]),onClick:o[3]||(o[3]=n=>m.$emit("start")),rounded:""},null,8,["class"]),[[h,"Start",void 0,{left:!0}]]),I(g(_(M),{icon:"pi pi-stop-circle",class:T(["action-bar-button",{"action-bar-button-end":l.endMode}]),onClick:o[4]||(o[4]=n=>m.$emit("end")),rounded:""},null,8,["class"]),[[h,"End",void 0,{left:!0}]]),I(g(_(M),{icon:"pi pi-arrow-right-arrow-left",class:"action-bar-button",onClick:o[5]||(o[5]=n=>m.$emit("flip")),rounded:""},null,512),[[h,"Flip",void 0,{left:!0}]])])):Q("",!0),l.isMobile&&!l.isSessionRoute?(W(),C("div",He,[(W(!0),C(ae,null,fe(p.value,n=>(W(),C("button",{key:n.label,class:T(["mobile-action-btn",n.class]),onClick:x=>n.command(),title:n.tooltip},[A("i",{class:T(n.icon)},null,2)],10,Ne))),128))])):Q("",!0)],64)}}}),Fe=ee(De,[["__scopeId","data-v-da052474"]]),Ie={class:"cancel-dialog"},Be={class:"dialog-actions"},Pe=Z({__name:"CancelDialog",setup(l){const c=se(),u=he("dialogRef");function s(){u?.value&&u.value.close()}function p(){u?.value&&(u.value.close(),c.push("/routes"))}return(m,o)=>(W(),C("div",Ie,[o[2]||(o[2]=me('<div class="dialog-header" data-v-099accae><div class="header-icon" data-v-099accae><i class="pi pi-exclamation-triangle" data-v-099accae></i></div><h3 class="dialog-title" data-v-099accae>Cancel</h3></div><div class="dialog-content" data-v-099accae><p class="dialog-message" data-v-099accae>Are you sure you want to cancel?</p></div>',2)),A("div",Be,[g(_(M),{label:"No",severity:"secondary",outlined:"",class:"action-button cancel-button-no",onClick:s},{icon:oe(()=>[...o[0]||(o[0]=[A("i",{class:"pi pi-times"},null,-1)])]),_:1}),g(_(M),{label:"Yes",severity:"danger",class:"action-button cancel-button-yes",onClick:p},{icon:oe(()=>[...o[1]||(o[1]=[A("i",{class:"pi pi-check"},null,-1)])]),_:1})])]))}}),Oe=ee(Pe,[["__scopeId","data-v-099accae"]]),ze={class:"route-info-content"},Ye={class:"route-name"},je=Z({__name:"RouteEdit",setup(l){const c=Se();se();const u=ye(),s=ge(),p=be(),m=we(),o=ie(()=>c.path==="/session"),h=v(null),n=v(null),x=v(!1),j=v(1),P=v(!1),R=v(!1),H=v(!1),O=v({width:200,height:200}),f=v(null),y=v(null),L=v(!1),w=v(!1),d=v([]),i=v(null),b=v(new Set),r=v(null);let S=null;async function N(){if(console.log("handleSave called",{currentRoute:r.value}),!r.value||!r.value.id){console.warn("No route to save"),s.add({severity:"warn",summary:"Warning",detail:"No route to save",life:3e3});return}const e=[];d.value.forEach(t=>{e.push({id:t,type:k.start})}),Array.from(b.value).forEach(t=>{e.push({id:t,type:k.normal})}),i.value&&e.push({id:i.value,type:k.finish});const a={...r.value,data:{...r.value.data,problem:{holds:e}}};console.log("Saving route:",a);try{await u.saveRoute(a),console.log("Route saved successfully"),s.add({severity:"success",summary:"Success",detail:"Saved successfully",life:3e3})}catch(t){console.error("Failed to save route:",t),s.add({severity:"error",summary:"Error",detail:"Failed to save",life:3e3})}}function G(){m.open(Oe,{props:{header:"",style:{width:"90vw",maxWidth:"480px"},modal:!0,dismissableMask:!0,closable:!1,closeOnEscape:!0}})}function U(){if(!r.value){s.add({severity:"warn",summary:"Warning",detail:"No route to edit",life:3e3});return}m.open(xe,{data:{route:r.value},props:{header:"",style:{width:"90vw",maxWidth:"420px"},modal:!0,dismissableMask:!0,closable:!1,closeOnEscape:!0},onClose:async e=>{const a=e?.data;if(a&&a.name&&a.grade&&a.isEdit&&r.value)try{const t={...r.value,name:a.name,data:{...r.value.data,grade:a.grade}};await u.saveRoute(t),r.value=t,s.add({severity:"success",summary:"Success",detail:"Route updated successfully",life:3e3})}catch(t){console.error("Failed to update route:",t),s.add({severity:"error",summary:"Error",detail:"Failed to update route",life:3e3})}}})}function q(){p.require({message:"Are you sure you want to flip your selections?",header:"Flip Selections",icon:"pi pi-exclamation-triangle",rejectProps:{label:"No",severity:"secondary",outlined:!0},acceptProps:{label:"Yes",severity:"warning"},accept:()=>{console.log("Flip confirmed")}})}function K(){Re.send({type:"preview",route:{data:{problem:{holds:[...d.value.map(e=>({id:e,type:k.start})),...Array.from(b.value).map(e=>({id:e,type:k.normal})),...i.value?[{id:i.value,type:k.finish}]:[]]}}}})}function E(){L.value=!0,w.value=!1,s.add({severity:"info",summary:"Start",detail:"Select two elements to start",life:3e3})}function V(){w.value=!0,L.value=!1,s.add({severity:"info",summary:"End",detail:"Select one end element",life:3e3})}function z(e,a){if(!n.value||!n.value.clientWidth){setTimeout(()=>{n.value&&n.value.clientWidth&&z()},50);return}const t=n.value.clientWidth,$=n.value.clientHeight;if(t===0||$===0){setTimeout(()=>{if(n.value){const F=n.value.clientWidth,ve=n.value.clientHeight;F>0&&ve>0&&z()}},50);return}O.value.width=t,O.value.height=$,j.value=t/$,x.value=j.value>.78;const D=window.innerWidth,J=window.innerHeight;if(P.value=D<640,R.value=D>=640&&D<1024,H.value=D>J,f.value&&y.value){const F=f.value.getNode();ne(y.value,F),F.draw()}}let X=null;ke(async()=>{await _e();const e=c.query.id?Number(c.query.id):null;if(e){await u.getRoutes();const a=u.routes.find(t=>t.id===e);a&&(r.value=a,console.log("Route loaded:",a.name,a.data.grade),a.data?.problem?.holds&&a.data.problem.holds.forEach(t=>{t.type===k.start?d.value.push(t.id):t.type===k.finish?i.value=t.id:t.type===k.normal&&b.value.add(t.id)}))}setTimeout(()=>{f.value&&(f.value.getNode(),de(),setTimeout(()=>{z(),Y()},50))},100),X=()=>{z(),H.value=window.innerWidth>window.innerHeight},window.addEventListener("resize",X),H.value=window.innerWidth>window.innerHeight,S=new ResizeObserver(()=>{setTimeout(()=>{z()},10)}),setTimeout(()=>{S&&(h.value&&S.observe(h.value),n.value&&S.observe(n.value))},100)}),Ee(()=>{S&&S.disconnect(),X&&window.removeEventListener("resize",X)});function le(e){L.value?re(e):w.value?ce(e):ue(e),K()}function re(e){const a=d.value.indexOf(e);if(a>-1){d.value.splice(a,1),Y();return}d.value.length<2?d.value.push(e):d.value[0]=e,d.value.length===2&&(L.value=!1),Y()}function ce(e){if(i.value===e){i.value=null,Y();return}i.value=e,w.value=!1,Y()}function ue(e){if(d.value.includes(e)||i.value===e||!f.value||!y.value)return;f.value.getNode();const a=y.value.findOne(`#${e}`);if(!a)return;b.value.has(e)?(b.value.delete(e),a.opacity(.3)):(b.value.add(e),a.opacity(1)),a.getLayer()?.batchDraw()}function Y(){if(!y.value||!f.value)return;const e=f.value.getNode(),a=y.value.children;a&&(a.forEach(t=>{const $=t.id(),D=d.value.includes($),J=i.value===$,F=b.value.has($);D?(t.fill("green"),t.opacity(1)):J?(t.fill("red"),t.opacity(1)):(t.fill("white"),F?t.opacity(1):t.opacity(.3))}),e.draw())}async function de(){const e=f.value.getNode();y.value=await Te(le,d.value,i.value),ne(y.value,e),e.add(y.value),e.draw()}return(e,a)=>{const t=Me("v-stage");return W(),C("div",{ref_key:"box",ref:h,class:T(["flex relative touch-none items-center justify-center w-full route-edit-container",{"h-full":!0,"pt-[80px]":R.value,"session-route":o.value}]),style:{"min-height":"0",position:"relative","pointer-events":"auto",overflow:"hidden"}},[g(Fe,{"is-mobile":P.value,"is-session-route":o.value,"start-mode":L.value,"end-mode":w.value,onSave:N,onCancel:G,onEditInfo:U,onFlip:q,onStart:E,onEnd:V},null,8,["is-mobile","is-session-route","start-mode","end-mode"]),A("div",{ref_key:"innerbox",ref:n,class:T(["relative bg-cover bg-center flex items-center justify-center overflow-hidden",{"canvas-container":!0,"tablet-canvas":R.value}]),style:Ce({backgroundImage:`url(${_(Le)})`,zIndex:1,pointerEvents:"auto"})},[g(t,{ref_key:"stage",ref:f,config:O.value,class:"touch-none canvas-stage"},null,8,["config"])],6),r.value&&!o.value?(W(),C("div",{key:0,class:T(["route-info-bar",{"route-info-mobile":P.value,"route-info-tablet":R.value,"route-info-tablet-landscape":R.value&&H.value}])},[A("div",ze,[A("span",Ye,We(r.value.name),1),g($e,{grade:r.value.data.grade},null,8,["grade"])])],2)):Q("",!0)],2)}}}),Ve=ee(je,[["__scopeId","data-v-b6458cfe"]]);export{Ve as R};
